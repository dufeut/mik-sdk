#!/bin/sh
# Pre-commit hook for Rust code quality
# Only runs on Rust-related changes (*.rs, Cargo.toml, Cargo.lock)
# Matches CI workflow flags for consistency

# Check if any Rust files are staged
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rs)$|Cargo\.(toml|lock)$')

if [ -z "$RUST_FILES" ]; then
    # No Rust files changed, skip checks
    exit 0
fi

echo "ğŸ¦€ Running Rust quality checks..."

# Format check
echo "  â†’ Checking formatting..."
if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "âŒ Format check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi
echo "  âœ“ Formatting OK"

# Clippy - matches CI: exclude examples (need WASM target)
echo "  â†’ Running clippy..."
CLIPPY_OUTPUT=$(cargo clippy --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --all-targets --all-features -- -D warnings 2>&1)
CLIPPY_EXIT=$?
if [ $CLIPPY_EXIT -ne 0 ]; then
    echo "$CLIPPY_OUTPUT" | tail -20
    echo "âŒ Clippy found issues. Fix them before committing."
    exit 1
fi
echo "  âœ“ Clippy OK"

# Quick compile check
echo "  â†’ Checking compilation..."
if ! cargo check --workspace --exclude hello-world --exclude crud-api --exclude auth-api --exclude external-api --exclude resilient-api --all-features > /dev/null 2>&1; then
    echo "âŒ Compilation failed."
    exit 1
fi
echo "  âœ“ Compilation OK"

echo "âœ… All Rust checks passed!"
exit 0
